version: '3.8'

# ==============================================================================
# VoidProbe Server - Docker Compose
# ==============================================================================
#
# Configuração do servidor de túnel reverso
#
# Funcionalidades:
# - Aceita conexões de clientes remotos
# - Permite administradores conectarem localmente
# - Túnel bidirecional persistente
# - Logs de auditoria completos

services:
  server:
    build:
      context: ../../
      dockerfile: deploy/servidor/Dockerfile
    image: voidprobe-server:latest
    container_name: voidprobe-server
    hostname: voidprobe-server

    # Restart automático (exceto quando parado manualmente)
    restart: unless-stopped

    # Portas expostas
    ports:
      # Porta gRPC para clientes remotos (acesso externo)
      - "50051:50051"

      # Porta para administradores (APENAS localhost por segurança)
      # Administradores devem usar: ssh -p 2222 user@localhost
      - "127.0.0.1:2222:2222"

      # Porta de métricas (opcional, apenas localhost)
      - "127.0.0.1:9090:9090"

    # Variáveis de ambiente
    environment:
      # Autenticação (OBRIGATÓRIO)
      - AUTH_TOKEN=${AUTH_TOKEN:?AUTH_TOKEN não definido}

      # Configuração do servidor
      - SERVER_ADDRESS=0.0.0.0
      - SERVER_PORT=50051
      - LOG_LEVEL=info

      # TLS/Segurança
      - TLS_ENABLED=true
      - TLS_CERT_FILE=/certs/server.crt
      - TLS_KEY_FILE=/certs/server.key

      # Métricas
      - METRICS_PORT=9090

    # Volumes
    volumes:
      # Certificados TLS (somente leitura)
      - ./certs:/certs:ro

      # Logs (leitura/escrita)
      - ./logs:/logs

      # Banco de dados SQLite
      - ./data:/opt/voidprobe/data

      # Configurações adicionais (opcional)
      - ./config:/config:ro

    # Rede isolada
    networks:
      - voidprobe-net

    # Limites de recursos (ajustar conforme necessário)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

    # Logging estruturado
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        labels: "service=voidprobe-server"

    # Health check
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "50051"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Security
    security_opt:
      - no-new-privileges:true

    # Capabilities (remove capacidades desnecessárias)
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE

    # Read-only root filesystem (aumenta segurança)
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100M

# ==============================================================================
# Rede
# ==============================================================================
networks:
  voidprobe-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ==============================================================================
# Volumes nomeados (opcional, para persistência)
# ==============================================================================
volumes:
  server-logs:
    driver: local
  server-certs:
    driver: local
